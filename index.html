<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/523/523050.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscaminas PRO</title>
    
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#ffcc00">
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* Estilo para bloquear el acceso hasta iniciar sesiÃ³n o elegir invitado */
        .game-locked { 
            opacity: 0.2; 
            pointer-events: none; 
            filter: grayscale(1); 
            transition: all 0.4s ease;
        }

        /* Se mantiene visible pero bloqueado por la clase superior */
        .game-content { 
            display: block; 
            flex-direction: column;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        /* --- NUEVOS ESTILOS DE ORGANIZACIÃ“N COMPACTA --- */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            width: 95%;
            max-width: 900px; 
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .menu-grid { grid-template-columns: 1fr; } 
        }

        .menu-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            box-sizing: border-box;
        }

        .menu-section h3 {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .full-width { grid-column: span 2; }

        .theme-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
        }

        #theme-sample {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #ffcc00;
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
            transition: background-color 0.3s ease;
            background-color: #3498db;
        }

        #skin-select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ffcc00;
            background: #111;
            color: white;
            font-family: inherit;
            cursor: pointer;
            flex-grow: 1;
        }

        #historyTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin: 15px 0;
        }
        #historyTable th {
            color: #ffcc00;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        #historyTable td {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 8px;
            color: #eee;
        }
        #historyTable td:first-child { border-radius: 8px 0 0 8px; }
        #historyTable td:last-child { border-radius: 0 8px 8px 0; }
        
        .res-win { color: #00ff88 !important; font-weight: bold; }
        .res-loss { color: #ff4444 !important; opacity: 0.8; }

        #rankList {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .rank-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #444;
            transition: transform 0.2s;
        }
        .rank-card.active { border-left-color: #ffcc00; background: rgba(255, 204, 0, 0.05); }
        .rank-mode { font-weight: bold; color: #aaa; font-size: 0.9rem; }
        .rank-val { font-family: 'Courier New', monospace; color: #00f2ff; font-size: 1.1rem; }
        .rank-empty { color: #555; font-size: 0.8rem; font-style: italic; }
    </style>
</head>
<body class="moderno">

    <div id="menu" class="screen">
        <h1>ğŸ’£ BUSCAMINAS PRO</h1>

        <div id="auth-container" style="margin-bottom: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 2px solid #ffcc00; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 15px rgba(255, 204, 0, 0.1); margin-left: auto; margin-right: auto;">
            <div id="auth-logged-out">
                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 10px;">IdentifÃ­cate para jugar y guardar tu progreso</p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" id="auth-username" placeholder="Nombre de usuario" style="padding: 10px; border-radius: 6px; border: 1px solid #444; background: #111; color: white;">
                    <input type="password" id="auth-password" placeholder="ContraseÃ±a" style="padding: 10px; border-radius: 6px; border: 1px solid #444; background: #111; color: white;">
                    <div style="display: flex; gap: 5px;">
                        <button id="btn-login" class="special-btn" style="flex: 1;">Entrar</button>
                        <button id="btn-register" style="flex: 1; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">Registrar</button>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 10px;">
                        <button id="btn-guest" style="width: 100%; background: none; border: 1px dashed #555; color: #888; cursor: pointer; padding: 8px; border-radius: 6px; font-size: 0.8rem;">Jugar como Invitado (Solo Local)</button>
                    </div>
                </div>
            </div>
            <div id="auth-logged-in" style="display: none;">
                <p style="margin: 0;">Bienvenido, <span id="display-username" style="color: #ffcc00; font-weight: bold;">Usuario</span></p>
                <button id="btn-logout" style="margin-top: 8px; font-size: 0.7rem; background: none; border: 1px solid #444; color: #777; cursor: pointer; padding: 4px 10px; border-radius: 4px;">Cerrar SesiÃ³n</button>
            </div>
        </div>
        
        <div id="main-game-menu" class="game-content">
            <div class="menu-grid">
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="menu-section">
                        <h3>ğŸ® Modo de Juego</h3>
                        <div class="button-grid difficulty-group">
                            <button id="btn-easy">FÃ¡cil</button>
                            <button id="btn-medium">Media</button>
                            <button id="btn-hard">DifÃ­cil</button>
                            <button id="btn-expert">ğŸ˜ˆ Experto</button>
                            <button id="btn-custom" class="full-width">âš™ï¸ Personalizado</button>
                            <button id="btn-blitz" class="special-btn full-width">âš¡ Modo Blitz (30s)</button>
                        </div>
                    </div>

                    <div class="menu-section">
                        <div id="duel-setup" style="text-align: center;">
                            <h4 style="margin: 0 0 10px 0; color: #888; font-size: 0.75rem;">âš”ï¸ MODO DUELO 1VS1</h4>
                            <button id="btn-create-duel" class="special-btn" style="width: 100%;">Crear Sala de Duelo</button>
                            
                            <div id="duel-link-container" style="display: none; margin-top: 10px;">
                                <input type="text" id="duel-url" readonly style="width: 70%; padding: 8px; border-radius: 5px; border: none; background: #000; color: #0ff; font-size: 0.8rem;">
                                <button id="btn-copy-link" style="padding: 8px 10px;">ğŸ“‹</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="menu-section">
                        <h3>ğŸ¨ PersonalizaciÃ³n</h3>
                        <div class="theme-container">
                            <div id="theme-sample"></div>
                            <select id="skin-select">
                                <option value="moderno">ğŸ§Š Moderno</option>
                                <option value="winter">â„ï¸ Invierno</option>
                                <option value="halloween">ğŸ’€ Halloween</option>
                                <option value="cyberpunk">ğŸŒŒ Cyberpunk</option>
                                <option value="clasico">ğŸªŸ ClÃ¡sico</option>
                                <option value="minimal">â—»ï¸ Minimal</option>
                            </select>
                        </div>
                    </div>

                    <div class="menu-section">
                        <h3>ğŸ“Š Tu Progreso</h3>
                        <div class="button-grid meta-buttons">
                            <button id="btn-achievements">ğŸ–ï¸ Logros</button>
                            <button id="btn-stats">ğŸ“Š Stats</button>
                            <button id="btn-ranking">ğŸ† RÃ©cords</button>
                            <button id="btn-history-modal">ğŸ“œ Historial</button>
                            <button id="btn-ranking-global" class="special-btn full-width">ğŸŒ Ranking Global</button>
                        </div>
                    </div>
                </div>

            </div> 
        </div>
    </div>

    <div id="gameUI" class="screen">
        <div id="duel-header" style="display: none; justify-content: space-between; align-items: center; width: 100%; max-width: 400px; padding: 10px; margin-bottom: 10px;">
            <div class="player-score">TÃš: <span id="my-score">0</span></div>
            <div class="vs-badge">VS</div>
            <div class="player-score">RIVAL: <span id="opp-score">0</span></div>
        </div>

        <div id="topbar">
            <div class="stat-group">
                <span>ğŸ’£</span> <span id="mines">0</span>
            </div>
            <div class="stat-group">
                <span>ğŸš©</span> <span id="flags">0</span>
            </div>
            <div class="stat-group">
                <span id="timer-icon">â±ï¸</span> <span id="time">0</span>s
            </div>
            <button id="btn-home-game">ğŸ </button>
        </div>

        <div id="board"></div>

        <div id="duel-chat" style="display: none; margin-top: 15px; gap: 10px; justify-content: center;">
            <button class="chat-btn">ğŸ˜</button>
            <button class="chat-btn">ğŸ¯</button>
            <button class="chat-btn">ğŸ’¥</button>
            <button class="chat-btn">GG</button>
            <button class="chat-btn">â“</button>
        </div>
    </div>

    <div id="chat-bubble-rival" class="chat-bubble"></div>
    
    <div id="globalRankModal" class="modal">
        <div class="modalContent" style="max-width: 600px;">
            <h3>ğŸŒ Ranking Mundial (Top 10)</h3>
            <div class="rank-tabs" style="display: flex; gap: 5px; margin-bottom: 15px; justify-content: center;">
                <button onclick="window.UI.renderGlobalRank('easy')">FÃ¡cil</button>
                <button onclick="window.UI.renderGlobalRank('medium')">Medio</button>
                <button onclick="window.UI.renderGlobalRank('hard')">DifÃ­cil</button>
                <button onclick="window.UI.renderGlobalRank('expert')">Experto</button>
            </div>
            <div id="global-rank-container"><p>Cargando clasificaciones...</p></div>
            <button class="close-modal-btn">Cerrar</button>
        </div>
    </div>

    <div id="winModal" class="modal">
        <div class="modalContent">
            <h1>ğŸ† HAS GANADO</h1>
            <p>Tiempo: <b><span id="finalTime"></span>s</b></p>
            <button class="btn-replay">ğŸ“º Ver Replay</button>
            <button class="btn-restart">ğŸ”„ Volver a jugar</button>
            <button class="btn-home">ğŸ  Inicio</button>
        </div>
    </div>

    <div id="loseModal" class="modal">
        <div class="modalContent">
            <h1 id="lose-title">ğŸ’¥ HAS PERDIDO</h1>
            <p id="lose-msg"></p>
            <button class="btn-replay">ğŸ“º Ver Replay</button>
            <button class="btn-restart">ğŸ”„ Volver a jugar</button>
            <button class="btn-home">ğŸ  Inicio</button>
        </div>
    </div>

    <div id="achModal" class="modal">
        <div class="modalContent">
            <h3>ğŸ–ï¸ Logros Desbloqueados</h3>
            <ul id="achList"></ul>
            <button class="close-modal-btn">Cerrar</button>
        </div>
    </div>

    <div id="rankModal" class="modal">
        <div class="modalContent">
            <h3 style="color: #ffcc00; margin-bottom: 20px;">ğŸ† Mejores Tiempos Locales</h3>
            <ul id="rankList"></ul>
            <button class="close-modal-btn">Cerrar</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modalContent" style="max-width: 550px;">
            <h3 style="color: #ffcc00; margin-bottom: 10px;">ğŸ“œ Historial Reciente</h3>
            <table id="historyTable">
                <thead>
                    <tr><th>Fecha</th><th>Modo</th><th>Tiempo</th><th>Resultado</th></tr>
                </thead>
                <tbody id="historyBody" style="text-align: center;"></tbody>
            </table>
            <button class="close-modal-btn">Cerrar</button>
        </div>
    </div>

    <div id="customModal" class="modal">
        <div class="modalContent">
            <h3>âš™ï¸ Tablero Personalizado</h3>
            <div style="display:flex; flex-direction:column; gap:10px; margin: 15px 0;">
                <label>TamaÃ±o (8-30): <input type="number" id="custom-size" value="10" min="8" max="30"></label>
                <label>Minas: <input type="number" id="custom-mines" value="15" min="1"></label>
            </div>
            <button id="btn-start-custom">Empezar</button>
            <button class="close-modal-btn">Cancelar</button>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modalContent">
            <h3>ğŸ“Š EstadÃ­sticas Globales</h3>
            <div id="statsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; margin: 15px 0;"></div>
            <button class="close-modal-btn">Cerrar</button>
        </div>
    </div>

    <script type="module" src="js/db.js" defer></script>
    <script type="module" src="js/main.js" defer></script>
    
    <script>
        // Service Worker para PWA
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>